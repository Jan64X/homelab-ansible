global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'homelab'
    replica: 'prometheus-01'
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 10s
    metrics_path: /metrics
    
  - job_name: 'node-exporter'
    scrape_interval: 15s
    metrics_path: /metrics
    static_configs:
{% for host in groups['all'] %}
{% if hostvars[host]['ansible_host'] is defined and 'monitoring-hl' in hostvars[host].get('host_roles', []) %}
      - targets: ['{{ hostvars[host]['ansible_host'] }}:9100']
        labels:
          service: 'node-exporter'
          env: 'homelab'
          hostname: '{{ hostvars[host].get('hostname', host) }}'
{% endif %}
{% endfor %}
{% for host in groups['all'] %}
{% if hostvars[host]['ansible_host'] is defined and 'monitoring-vps' in hostvars[host].get('host_roles', []) %}
      - targets: ['{{ hostvars[host]['ansible_host'] }}:9100']
        labels:
          service: 'node-exporter'
          env: 'vps'
          hostname: '{{ hostvars[host].get('hostname', host) }}'
{% endif %}
{% endfor %}
    relabel_configs:
      # Preserve original instance (IP:port) as host_address
      - source_labels: [__address__]
        target_label: host_address
      # Replace instance label with hostname for better readability
      - source_labels: [hostname]
        target_label: instance
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
        labels:
          service: 'grafana'
          env: 'homelab'
    scrape_interval: 30s
    metrics_path: /metrics
  # Service-specific exporters - add these later when you set up proper exporters
  # - job_name: 'searxng-exporter'
  #   static_configs:
  #     - targets: ['searxng-host:9115']  # Example for blackbox exporter
  
  # - job_name: 'gitlab-exporter'  
  #   static_configs:
  #     - targets: ['gitlab-host:9168']  # GitLab's built-in metrics
  
  # - job_name: 'nginx-exporter'
  #   static_configs:
  #     - targets: ['nginx-host:9113']  # nginx-prometheus-exporter