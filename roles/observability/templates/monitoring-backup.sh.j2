#!/bin/bash

# Monitoring automated backup script (Grafana + Prometheus)
# Managed by Ansible - DO NOT EDIT MANUALLY

set -e

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
NAS_MOUNT="/mnt/monitoring_data"
LOG_PREFIX="[$(date '+%Y-%m-%d %H:%M:%S')] Monitoring Backup:"

log() {
    echo "${LOG_PREFIX} $1"
}

cleanup() {
    if mountpoint -q "${NAS_MOUNT}"; then
        cd /
        umount "${NAS_MOUNT}" || log "Warning: Failed to unmount NAS"
    fi
}

trap cleanup EXIT

log "Starting monitoring backup process"

# Mount NAS
log "Mounting NAS storage"
if ! mount "${NAS_MOUNT}"; then
    log "ERROR: Failed to mount NAS storage"
    exit 1
fi

# Ensure backup directories exist on NAS
mkdir -p "${NAS_MOUNT}/backups/grafana"
mkdir -p "${NAS_MOUNT}/backups/prometheus"

# Stop services temporarily for consistent backup
log "Stopping monitoring services for backup"
docker stop grafana prometheus || true

# Wait a moment for services to fully stop
sleep 5

# Backup Grafana data
log "Backing up Grafana data"
GRAFANA_BACKUP_FILE="${NAS_MOUNT}/backups/grafana/grafana_backup_${BACKUP_DATE}.tar.gz"
if ! tar -czf "${GRAFANA_BACKUP_FILE}" -C /var/lib grafana; then
    log "ERROR: Failed to backup Grafana data"
    docker start grafana prometheus || true
    exit 1
fi

# Backup Prometheus data
log "Backing up Prometheus data"
PROMETHEUS_BACKUP_FILE="${NAS_MOUNT}/backups/prometheus/prometheus_backup_${BACKUP_DATE}.tar.gz"
if ! tar -czf "${PROMETHEUS_BACKUP_FILE}" -C /var/lib prometheus; then
    log "ERROR: Failed to backup Prometheus data"
    docker start grafana prometheus || true
    exit 1
fi

# Start services again
log "Restarting monitoring services"
if ! docker start grafana prometheus; then
    log "ERROR: Failed to restart monitoring services"
    exit 1
fi

# Wait for services to be ready
log "Waiting for services to be ready"
sleep 10

# Verify services are running
if ! docker ps | grep -q grafana; then
    log "WARNING: Grafana container not running after restart"
fi

if ! docker ps | grep -q prometheus; then
    log "WARNING: Prometheus container not running after restart"
fi

# Cleanup old Grafana backups (keep last 14)
log "Cleaning up old Grafana backups (keeping last 14)"
cd "${NAS_MOUNT}/backups/grafana"
ls -t grafana_backup_*.tar.gz 2>/dev/null | tail -n +15 | xargs rm -f || true

# Cleanup old Prometheus backups (keep last 14)
log "Cleaning up old Prometheus backups (keeping last 14)"
cd "${NAS_MOUNT}/backups/prometheus"
ls -t prometheus_backup_*.tar.gz 2>/dev/null | tail -n +15 | xargs rm -f || true

log "Monitoring backup completed successfully"

# Verify backup integrity
log "Verifying backup integrity"
if tar -tzf "${GRAFANA_BACKUP_FILE}" > /dev/null 2>&1; then
    log "Grafana backup integrity check passed"
else
    log "WARNING: Grafana backup integrity check failed"
fi

if tar -tzf "${PROMETHEUS_BACKUP_FILE}" > /dev/null 2>&1; then
    log "Prometheus backup integrity check passed"
else
    log "WARNING: Prometheus backup integrity check failed"
fi

log "Backup process finished successfully"
