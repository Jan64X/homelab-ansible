global:
  scrape_interval: 30s
  evaluation_interval: 30s
  external_labels:
    monitor: 'external-monitor'
    location: '{{ inventory_hostname }}'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        # This tells Prometheus to send alerts to the Alertmanager container
        - targets: ['alertmanager:9093']

# Load alert rules
rule_files:
  - '/etc/prometheus/alert_rules.yml'

# Scrape configuration
scrape_configs:
  # Scrape the Blackbox exporter to probe the homelab
  - job_name: 'blackbox_homelab'
    metrics_path: /probe
    params:
      module: [http_prometheus]  # Use the module defined in blackbox.yml
    
    static_configs:
      # This is the FULL target URL we want Blackbox to probe
      # It's now correctly using your Ansible variable
      - targets:
          - 'http://{{ home_public_ip }}:9090/metrics' 
    
    relabel_configs:
      # Take the full target URL...
      - source_labels: [__address__]
        # ...and set it as the 'target' URL parameter for the /probe endpoint.
        target_label: __param_target
      
      # Set the 'instance' label to be just 'host:port'
      - source_labels: [__param_target]
        target_label: instance
        regex: 'https?://([^/]+)/.*'
        replacement: '$1'

      # Finally, set the scrape address to be the Blackbox exporter itself.
      - target_label: __address__
        replacement: blackbox-exporter:9115