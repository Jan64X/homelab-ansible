services:
  prometheus:
    image: prom/prometheus:latest
    container_name: external-prometheus
    restart: unless-stopped
    user: "65534:65534"  # nobody user for security
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - /etc/external-monitor/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - /etc/external-monitor/prometheus/alert_rules.yml:/etc/prometheus/alert_rules.yml:ro
      - /var/lib/external-prometheus:/prometheus
      - /etc/localtime:/etc/localtime:ro
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.listen-address=0.0.0.0:9090'
      - '--storage.tsdb.wal-compression'
    networks:
      - external-monitor
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  alertmanager:
    image: prom/alertmanager:latest
    container_name: external-alertmanager
    restart: unless-stopped
    user: "65534:65534"  # nobody user for security
    ports:
      - "127.0.0.1:9093:9093"
    volumes:
      - /etc/external-monitor/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - /var/lib/external-alertmanager:/alertmanager
      - /etc/localtime:/etc/localtime:ro
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.listen-address=0.0.0.0:9093'
    networks:
      - external-monitor
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  blackbox-exporter:
      image: prom/blackbox-exporter:latest
      container_name: external-blackbox-exporter
      restart: unless-stopped
      user: "65534:65534" # nobody
      ports:
        - "127.0.0.1:9115:9115"
      volumes:
        - /etc/external-monitor/blackbox/config.yml:/etc/blackbox_exporter/config.yml:ro
        - /etc/localtime:/etc/localtime:ro
      command:
        - '--config.file=/etc/blackbox_exporter/config.yml'
        - '--web.listen-address=:9115'
      networks:
        - external-monitor
      healthcheck:
        test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9115/"]
        interval: 30s
        timeout: 10s
        retries: 3
        start_period: 30s

networks:
  external-monitor:
    driver: bridge
