#!/bin/bash

# Sharkey Backup Script
# This script backs up the Sharkey database to the NAS mount

BACKUP_DIR="/mnt/nas_sharkey"
DB_BACKUP_FILENAME="sharkey_db_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
FILES_BACKUP_FILENAME="sharkey_files_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
SHARKEY_DIR="/opt/sharkey"
DB_DIR="/opt/sharkey/db"
FILES_DIR="/opt/sharkey/files"
RETENTION_DAYS=14

# Ensure NAS is mounted
if ! mount | grep -q "{{ nas_ip }}/tank/server/sharkey"; then
  echo "NAS not mounted. Attempting to mount..."
  mount /mnt/nas_sharkey
  
  if [ $? -ne 0 ]; then
    echo "Failed to mount NAS. Backup aborted."
    exit 1
  fi
fi

# Stop Sharkey container for consistent backup
echo "Stopping Sharkey container for backup..."
cd "$SHARKEY_DIR"
docker compose down

# Check if database directory exists
if [ ! -d "$DB_DIR" ]; then
  echo "Database directory $DB_DIR not found. Backup aborted."
  docker compose up -d
  exit 1
fi

# Check if files directory exists
if [ ! -d "$FILES_DIR" ]; then
  echo "Files directory $FILES_DIR not found. Backup aborted."
  docker compose up -d
  exit 1
fi

# Create backup of database directory
echo "Creating backup of Sharkey database..."
tar -czf "/tmp/$DB_BACKUP_FILENAME" -C /opt/sharkey db

# Create backup of files directory
echo "Creating backup of Sharkey files..."
tar -czf "/tmp/$FILES_BACKUP_FILENAME" -C /opt/sharkey files

# Copy backups to NAS
echo "Copying database backup to NAS..."
cp "/tmp/$DB_BACKUP_FILENAME" "$BACKUP_DIR/"

echo "Copying files backup to NAS..."
cp "/tmp/$FILES_BACKUP_FILENAME" "$BACKUP_DIR/"

# Remove temporary files
rm "/tmp/$DB_BACKUP_FILENAME"
rm "/tmp/$FILES_BACKUP_FILENAME"

# Start Sharkey container back up
echo "Starting Sharkey container..."
docker compose up -d

# Wait a moment for container to start
sleep 5

# Clean up old backups
echo "Cleaning up old backups..."
find "$BACKUP_DIR" -name "sharkey_db_backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "sharkey_files_backup_*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: Database and Files backed up successfully"
echo "Sharkey container restarted successfully."
exit 0