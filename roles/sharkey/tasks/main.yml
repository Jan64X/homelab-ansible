---
- name: Check if Sharkey container exists
  community.docker.docker_container_info:
    name: sharkey
  register: sharkey_container
  ignore_errors: true
  become: true

- name: Check if Sharkey initial setup is complete
  ansible.builtin.stat:
    path: /opt/sharkey/.setup_complete
  register: sharkey_setup_complete

- name: Check if Sharkey has been installed (restored from backup or fresh install)
  ansible.builtin.stat:
    path: /opt/sharkey/.installed
  register: sharkey_installed

- name: Install required packages for Docker repository
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
      - python3-requests
    state: present
    update_cache: true
  become: true

- name: Create directory for Docker GPG key
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: true

- name: Add Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: '0644'
  become: true

- name: Set Docker GPG key permissions
  ansible.builtin.file:
    path: /etc/apt/keyrings/docker.asc
    mode: '0644'
    owner: root
    group: root
  become: true

- name: Get system architecture
  ansible.builtin.command: dpkg --print-architecture
  register: sharkey_system_arch
  changed_when: false

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ sharkey_system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] 
      https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable
    state: present
    filename: docker
  become: true

- name: Install Docker and Docker Compose plugin
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-compose-plugin
    state: present
    update_cache: true
  become: true

- name: Ensure Docker service is running
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  become: true

- name: Create Sharkey directories
  ansible.builtin.file:
    path: "{{ directory_item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/sharkey/
    - /opt/sharkey/.config
  loop_control:
    loop_var: directory_item
  become: true

- name: Load NAS credentials
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/credentials/nas_creds.txt"
  no_log: true

- name: Ensure NAS mount directory exists
  ansible.builtin.file:
    path: /mnt/nas_sharkey
    state: directory
    mode: '0755'
  become: true

- name: Add NAS share to fstab (noauto)
  ansible.posix.mount:
    path: /mnt/nas_sharkey
    src: "//{{ nas_ip }}/tank/Server/sharkey"
    fstype: cifs
    opts: "username={{ nas_user }},password={{ nas_password }},uid=1000,gid=1000,noauto"
    state: present
  become: true
  no_log: true

- name: Mount NAS for backup operations
  ansible.builtin.command: mount /mnt/nas_sharkey
  become: true
  changed_when: false
  failed_when: false

# PASSWORD GENERATION BLOCK - Place here after NAS is mounted but before config templates
# Database password management
- name: Check if Sharkey database password file exists on NAS
  ansible.builtin.stat:
    path: /mnt/nas_sharkey/db_password.txt
  register: sharkey_nas_db_password_file
  become: true

- name: Check if Sharkey database password file exists locally
  ansible.builtin.stat:
    path: /opt/sharkey/db_password.txt
  register: sharkey_local_db_password_file
  become: true

- name: Read existing database password from NAS if it exists
  ansible.builtin.slurp:
    src: /mnt/nas_sharkey/db_password.txt
  register: existing_sharkey_nas_db_password
  when: sharkey_nas_db_password_file.stat.exists
  become: true
  no_log: true

- name: Read existing database password from local if it exists (fallback)
  ansible.builtin.slurp:
    src: /opt/sharkey/db_password.txt
  register: existing_sharkey_local_db_password
  when: 
    - not sharkey_nas_db_password_file.stat.exists
    - sharkey_local_db_password_file.stat.exists
  become: true
  no_log: true

- name: Set database password from NAS file
  ansible.builtin.set_fact:
    sharkey_db_password: "{{ existing_sharkey_nas_db_password.content | b64decode | trim }}"
  when: sharkey_nas_db_password_file.stat.exists
  no_log: true

- name: Set database password from local file (fallback)
  ansible.builtin.set_fact:
    sharkey_db_password: "{{ existing_sharkey_local_db_password.content | b64decode | trim }}"
  when: 
    - not sharkey_nas_db_password_file.stat.exists
    - sharkey_local_db_password_file.stat.exists
  no_log: true

- name: Generate random database password if no password file exists
  ansible.builtin.set_fact:
    sharkey_db_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when: 
    - not sharkey_nas_db_password_file.stat.exists
    - not sharkey_local_db_password_file.stat.exists
  no_log: true

- name: Store database password on NAS for future use
  ansible.builtin.copy:
    content: "{{ sharkey_db_password }}"
    dest: /mnt/nas_sharkey/db_password.txt
    mode: '0600'
  become: true
  when: not sharkey_nas_db_password_file.stat.exists
  no_log: true

- name: Store database password locally for immediate use
  ansible.builtin.copy:
    content: "{{ sharkey_db_password }}"
    dest: /opt/sharkey/db_password.txt
    mode: '0600'
  become: true
  when: not sharkey_local_db_password_file.stat.exists
  no_log: true

# Initial password management
- name: Check if Sharkey initial password file exists on NAS
  ansible.builtin.stat:
    path: /mnt/nas_sharkey/initial_password.txt
  register: sharkey_nas_initial_password_file
  become: true

- name: Check if Sharkey initial password file exists locally
  ansible.builtin.stat:
    path: /opt/sharkey/initial_password.txt
  register: sharkey_local_initial_password_file
  become: true

- name: Read existing initial password from NAS if it exists
  ansible.builtin.slurp:
    src: /mnt/nas_sharkey/initial_password.txt
  register: existing_sharkey_nas_initial_password
  when: sharkey_nas_initial_password_file.stat.exists
  become: true
  no_log: true

- name: Read existing initial password from local if it exists (fallback)
  ansible.builtin.slurp:
    src: /opt/sharkey/initial_password.txt
  register: existing_sharkey_local_initial_password
  when: 
    - not sharkey_nas_initial_password_file.stat.exists
    - sharkey_local_initial_password_file.stat.exists
  become: true
  no_log: true

- name: Set initial password from NAS file
  ansible.builtin.set_fact:
    sharkey_initial_password: "{{ existing_sharkey_nas_initial_password.content | b64decode | trim }}"
  when: sharkey_nas_initial_password_file.stat.exists
  no_log: true

- name: Set initial password from local file (fallback)
  ansible.builtin.set_fact:
    sharkey_initial_password: "{{ existing_sharkey_local_initial_password.content | b64decode | trim }}"
  when: 
    - not sharkey_nas_initial_password_file.stat.exists
    - sharkey_local_initial_password_file.stat.exists
  no_log: true

- name: Generate random initial password if no password file exists
  ansible.builtin.set_fact:
    sharkey_initial_password: "{{ lookup('password', '/dev/null length=32 chars=ascii_letters,digits') }}"
  when: 
    - not sharkey_nas_initial_password_file.stat.exists
    - not sharkey_local_initial_password_file.stat.exists
  no_log: true

- name: Store initial password on NAS for future use
  ansible.builtin.copy:
    content: "{{ sharkey_initial_password }}"
    dest: /mnt/nas_sharkey/initial_password.txt
    mode: '0600'
  become: true
  when: not sharkey_nas_initial_password_file.stat.exists
  no_log: true

- name: Store initial password locally for immediate use
  ansible.builtin.copy:
    content: "{{ sharkey_initial_password }}"
    dest: /opt/sharkey/initial_password.txt
    mode: '0600'
  become: true
  when: not sharkey_local_initial_password_file.stat.exists
  no_log: true

# END PASSWORD GENERATION BLOCK

- name: Copy docker-compose.yml for Sharkey
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/sharkey/docker-compose.yml
    mode: '0644'
  become: true
  register: sharkey_settings_result

- name: Copy default.yml for Sharkey
  ansible.builtin.template:
    src: default.yml.j2
    dest: /opt/sharkey/.config/default.yml
    mode: '0644'
  become: true
  register: sharkey_compose_result

- name: Copy docker.env for Sharkey
  ansible.builtin.template:
    src: docker.env.j2
    dest: /opt/sharkey/.config/docker.env
    mode: '0644'
  become: true
  register: sharkey_logo_result

- name: Check if any backups exist on NAS
  ansible.builtin.find:
    paths: /mnt/nas_sharkey
    patterns: "sharkey_*backup_*.tar.gz"
  register: sharkey_backup_files
  become: true

- name: Restore from latest backup if available and not fresh install
  when: 
    - sharkey_backup_files.matched > 0 
    - not sharkey_fresh_install
    - not sharkey_installed.stat.exists
  block:
    - name: Find latest database backup
      ansible.builtin.shell: set -o pipefail && ls -t /mnt/nas_sharkey/sharkey_db_backup_*.tar.gz | head -1
      register: sharkey_latest_db_backup
      changed_when: false
      become: true
      args:
        executable: /bin/bash
      ignore_errors: true

    - name: Find latest files backup
      ansible.builtin.shell: set -o pipefail && ls -t /mnt/nas_sharkey/sharkey_files_backup_*.tar.gz | head -1
      register: sharkey_latest_files_backup
      changed_when: false
      become: true
      args:
        executable: /bin/bash
      ignore_errors: true

    - name: Stop any existing Sharkey container before restore
      community.docker.docker_compose_v2:
        project_src: /opt/sharkey
        state: absent
      become: true
      ignore_errors: true

    - name: Extract database backup to Sharkey directory
      ansible.builtin.unarchive:
        src: "{{ sharkey_latest_db_backup.stdout }}"
        dest: /opt/sharkey/
        remote_src: true
      become: true
      when: sharkey_latest_db_backup.stdout is defined and sharkey_latest_db_backup.rc == 0

    - name: Extract files backup to Sharkey directory
      ansible.builtin.unarchive:
        src: "{{ sharkey_latest_files_backup.stdout }}"
        dest: /opt/sharkey/
        remote_src: true
      become: true
      when: sharkey_latest_files_backup.stdout is defined and sharkey_latest_files_backup.rc == 0

    - name: Fix permissions on restored files
      ansible.builtin.file:
        path: /opt/sharkey/files
        owner: "991"
        group: "991"
        recurse: true
        state: directory
      become: true
      when: sharkey_latest_files_backup.stdout is defined and sharkey_latest_files_backup.rc == 0

- name: Ensure files directory exists with correct permissions
  ansible.builtin.file:
    path: /opt/sharkey/files
    owner: "991"
    group: "991"
    mode: '0755'
    state: directory
    recurse: true
  become: true

- name: Start Sharkey container
  community.docker.docker_compose_v2:
    project_src: /opt/sharkey
    state: present
    pull: "always"
  become: true

- name: Wait for Sharkey to initialize
  ansible.builtin.wait_for:
    port: 3000
    delay: 10
    timeout: 120

- name: Create setup complete state file
  ansible.builtin.file:
    path: /opt/sharkey/.setup_complete
    state: touch
    mode: '0644'
  become: true
  when: not sharkey_setup_complete.stat.exists

- name: Create installed state file
  ansible.builtin.file:
    path: /opt/sharkey/.installed
    state: touch
    mode: '0644'
  become: true
  when: not sharkey_installed.stat.exists

- name: Create backup script
  ansible.builtin.template:
    src: backup_sharkey.sh.j2
    dest: /opt/sharkey/backup_sharkey.sh
    mode: '0755'
  become: true

- name: Set up cron job for automatic backup
  ansible.builtin.cron:
    name: "Backup Sharkey to NAS"
    job: "/opt/sharkey/backup_sharkey.sh"
    hour: "2"
    minute: "0"
    user: root
  become: true

- name: Allow HTTP
  community.general.ufw:
    rule: allow
    port: 3000
    proto: tcp
  notify: Reload ufw