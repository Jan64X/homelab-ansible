#!/bin/bash

# UniFi Controller backup script
set -e

BACKUP_DIR="/mnt/nas_unifi"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
CONTAINER_NAME="unifi-network-application"

# Mount NAS if not already mounted
if ! mountpoint -q "$BACKUP_DIR"; then
    mount "$BACKUP_DIR" || {
        echo "ERROR: Failed to mount NAS backup directory"
        exit 1
    }
fi

# Ensure backup directory exists
mkdir -p "$BACKUP_DIR"

echo "Starting UniFi Controller backup at $(date)"

# Create backup using UniFi's built-in backup functionality
# The UniFi controller automatically creates backups in /config/data/backup/autobackup/
# We'll copy the latest backup file to NAS

UNIFI_BACKUP_DIR="/var/lib/unifi/data/backup/autobackup"

if [ -d "$UNIFI_BACKUP_DIR" ]; then
    # Find the latest backup file
    LATEST_BACKUP=$(ls -t "$UNIFI_BACKUP_DIR"/*.unf 2>/dev/null | head -1)
    
    if [ -n "$LATEST_BACKUP" ]; then
        BACKUP_FILENAME="unifi_backup_${TIMESTAMP}.unf"
        cp "$LATEST_BACKUP" "$BACKUP_DIR/$BACKUP_FILENAME"
        echo "Backup completed: $BACKUP_DIR/$BACKUP_FILENAME"
        
        # Keep only the latest 7 backups
        cd "$BACKUP_DIR"
        ls -t unifi_backup_*.unf 2>/dev/null | tail -n +8 | xargs -r rm
        echo "Old backups cleaned up"
    else
        echo "WARNING: No backup files found in UniFi backup directory"
        
        # Trigger a backup via UniFi API if possible
        # Note: This would require admin credentials and API access
        echo "Consider manually creating a backup via the UniFi web interface"
    fi
else
    echo "ERROR: UniFi backup directory not found: $UNIFI_BACKUP_DIR"
    exit 1
fi

echo "UniFi Controller backup completed at $(date)"
