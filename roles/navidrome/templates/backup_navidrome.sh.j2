#!/bin/bash

# Navidrome Backup Script
# This script backs up the Navidrome database to the NAS mount

BACKUP_DIR="/mnt/navidrome_backup"
DB_BACKUP_FILENAME="navidrome_db_backup_$(date +%Y%m%d_%H%M%S).db"
NAVIDROME_DIR="/opt/navidrome"
DB_FILE="/opt/navidrome/data/navidrome.db"
RETENTION_DAYS=14

# Ensure NAS is mounted
if ! mount | grep -q "{{ nas_ip }}/tank/Server/navidrome"; then
  echo "NAS not mounted. Attempting to mount..."
  mount /mnt/navidrome_backup
  
  if [ $? -ne 0 ]; then
    echo "Failed to mount NAS. Backup aborted."
    exit 1
  fi
fi

# Stop Navidrome container for consistent backup
echo "Stopping Navidrome container for backup..."
cd "$NAVIDROME_DIR"
docker compose down

# Check if database file exists
if [ ! -f "$DB_FILE" ]; then
  echo "Database file $DB_FILE not found. Backup aborted."
  docker compose up -d
  exit 1
fi

# Create backup of database file
echo "Creating backup of Navidrome database..."
cp "$DB_FILE" "/tmp/$DB_BACKUP_FILENAME"

# Copy backup to NAS
echo "Copying database backup to NAS..."
cp "/tmp/$DB_BACKUP_FILENAME" "$BACKUP_DIR/"

# Remove temporary file
rm "/tmp/$DB_BACKUP_FILENAME"

# Start Navidrome container back up
echo "Starting Navidrome container..."
docker compose up -d

# Wait a moment for container to start
sleep 5

# Clean up old backups
echo "Cleaning up old backups..."
find "$BACKUP_DIR" -name "navidrome_db_backup_*.db" -mtime +$RETENTION_DAYS -delete

echo "Backup completed: Database backed up successfully"
echo "Navidrome container restarted successfully."
exit 0
