#!/bin/bash

# GitLab automated backup script
# Managed by Ansible - DO NOT EDIT MANUALLY

set -e

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_NAME="${BACKUP_DATE}"  # Removed "daily_" prefix
NAS_MOUNT="/mnt/gitlab_data"
LOG_PREFIX="[$(date '+%Y-%m-%d %H:%M:%S')] GitLab Backup:"

log() {
    echo "${LOG_PREFIX} $1"
}

cleanup() {
    if mountpoint -q "${NAS_MOUNT}"; then
        umount "${NAS_MOUNT}" || log "Warning: Failed to unmount NAS"
    fi
}

trap cleanup EXIT

log "Starting GitLab backup process"

# Mount NAS
log "Mounting NAS storage"
if ! mount "${NAS_MOUNT}"; then
    log "ERROR: Failed to mount NAS storage"
    exit 1
fi

# Ensure backup directories exist on NAS
mkdir -p "${NAS_MOUNT}/backups"
mkdir -p "${NAS_MOUNT}/secrets"
mkdir -p "${NAS_MOUNT}/config"

# Create GitLab backup
log "Creating GitLab backup: ${BACKUP_NAME}"
if ! gitlab-backup create BACKUP="${BACKUP_NAME}"; then
    log "ERROR: Failed to create GitLab backup"
    exit 1
fi

# Copy backup to NAS
log "Copying backup to NAS"
if ! cp "/var/opt/gitlab/backups/${BACKUP_NAME}_gitlab_backup.tar" "${NAS_MOUNT}/backups/"; then
    log "ERROR: Failed to copy backup to NAS"
    exit 1
fi

# Copy secrets to NAS
log "Backing up GitLab secrets"
if ! cp /etc/gitlab/gitlab-secrets.json "${NAS_MOUNT}/secrets/"; then
    log "ERROR: Failed to copy secrets to NAS"
    exit 1
fi

# Copy configuration to NAS
log "Backing up GitLab configuration"
if ! cp /etc/gitlab/gitlab.rb "${NAS_MOUNT}/config/"; then
    log "ERROR: Failed to copy configuration to NAS"
    exit 1
fi

# Cleanup old local backups (keep last 3)
log "Cleaning up old local backups (keeping last 3)"
cd /var/opt/gitlab/backups
ls -t *_gitlab_backup.tar 2>/dev/null | tail -n +4 | xargs rm -f || true

# Cleanup old NAS backups (keep last 14)
log "Cleaning up old NAS backups (keeping last 14)"
cd "${NAS_MOUNT}/backups"
ls -t *_gitlab_backup.tar 2>/dev/null | tail -n +15 | xargs rm -f || true

log "GitLab backup completed successfully"

# Verify backup integrity
log "Verifying backup integrity"
BACKUP_FILE="${NAS_MOUNT}/backups/${BACKUP_NAME}_gitlab_backup.tar"
if tar -tf "${BACKUP_FILE}" > /dev/null 2>&1; then
    log "Backup integrity check passed"
else
    log "WARNING: Backup integrity check failed"
    exit 1
fi

log "Backup process finished successfully"