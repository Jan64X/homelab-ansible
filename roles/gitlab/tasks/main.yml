---
- name: Install required packages
  ansible.builtin.apt:
    name:
      - curl
      - openssh-server
      - ca-certificates
      - tzdata
      - perl
      - postfix
      - gpg
      - cifs-utils  # Added for NAS mounting
    state: present
    update_cache: true

- name: Add GitLab package repository GPG key
  ansible.builtin.get_url:
    url: https://packages.gitlab.com/gitlab/gitlab-ce/gpgkey
    dest: /tmp/gitlab.gpg
    mode: '0644'

- name: Import GitLab GPG key
  ansible.builtin.apt_key:
    file: /tmp/gitlab.gpg
    state: present

- name: Add GitLab repository
  ansible.builtin.apt_repository:
    repo: "deb https://packages.gitlab.com/gitlab/gitlab-ce/debian/ {{ ansible_distribution_release }} main"
    state: present
    filename: gitlab_gitlab-ce

- name: Check if GitLab is already managed by Ansible
  ansible.builtin.stat:
    path: /etc/gitlab/.ansible_managed
  register: gitlab_managed

# =============================================================================
# FIRST TIME SETUP - NAS MOUNTING AND BACKUP DISCOVERY
# =============================================================================

- name: Create NAS mount point
  ansible.builtin.file:
    path: /mnt/gitlab_data
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Load NAS credentials
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/credentials/nas_creds.txt"

- name: Mount NAS for initial setup (first time only)
  ansible.posix.mount:
    path: /mnt/gitlab_data
    src: "//{{ nas_ip }}/tank/Server/gitlab"
    fstype: cifs
    opts: "username={{ nas_user }},password={{ nas_password }},uid=0,gid=0,dir_mode=02770,iocharset=utf8,x-systemd.mount-timeout=15min"
    state: mounted
  when: not gitlab_managed.stat.exists

- name: Check if secrets exist on NAS (first time only)
  ansible.builtin.stat:
    path: /mnt/gitlab_data/secrets/gitlab-secrets.json
  register: nas_secrets_exist
  when: not gitlab_managed.stat.exists

- name: Check for latest backup on NAS (first time only)
  ansible.builtin.shell: |
    if [ -d "/mnt/gitlab_data/backups" ]; then
      ls -t /mnt/gitlab_data/backups/*_gitlab_backup.tar 2>/dev/null | head -n1 || echo ""
    else
      echo ""
    fi
  register: latest_backup
  when: not gitlab_managed.stat.exists
  changed_when: false

- name: Debug backup discovery
  ansible.builtin.debug:
    msg: 
      - "GitLab managed: {{ gitlab_managed.stat.exists }}"
      - "Latest backup found: '{{ latest_backup.stdout }}'"
      - "Force restore from group var: {{ gitlab_force_restore | default(false) }}"
      - "Force fresh install from group var: {{ gitlab_force_fresh_install | default(false) }}"
  when: not gitlab_managed.stat.exists

- name: Set restoration facts
  ansible.builtin.set_fact:
    should_restore_backup: "{{ gitlab_force_restore | default(false) or (not gitlab_managed.stat.exists and latest_backup.stdout != '') }}"
    is_fresh_install: "{{ gitlab_force_fresh_install | default(false) or (not gitlab_managed.stat.exists and latest_backup.stdout == '' and not (gitlab_force_restore | default(false))) }}"
  when: not gitlab_managed.stat.exists

- name: Debug restoration decisions
  ansible.builtin.debug:
    msg:
      - "Will restore backup: {{ should_restore_backup | default(false) }}"
      - "Will do fresh install: {{ is_fresh_install | default(false) }}"
  when: not gitlab_managed.stat.exists

# =============================================================================
# GITLAB INSTALLATION AND BASIC CONFIGURATION
# =============================================================================

- name: Check if GitLab configuration directory exists
  ansible.builtin.stat:
    path: /etc/gitlab
  register: gitlab_config_dir

- name: Create GitLab configuration directory (if needed)
  ansible.builtin.file:
    path: /etc/gitlab
    state: directory
  when: not gitlab_config_dir.stat.exists

- name: Restore GitLab secrets from NAS (first time setup)
  ansible.builtin.copy:
    src: /mnt/gitlab_data/secrets/gitlab-secrets.json
    dest: /etc/gitlab/gitlab-secrets.json
    remote_src: yes
    owner: root
    group: root
    mode: '0600'
  when: not gitlab_managed.stat.exists and nas_secrets_exist.stat.exists

- name: Configure GitLab (initial configuration)
  ansible.builtin.template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb
    mode: '0600'
    owner: root
    group: root

- name: Install GitLab CE (skip initial reconfigure)
  ansible.builtin.apt:
    name: gitlab-ce
    state: present
    update_cache: true
  environment:
    GITLAB_SKIP_RECONFIGURE: "true"

- name: Create GitLab backups directory
  ansible.builtin.file:
    path: /var/opt/gitlab/backups
    state: directory
    owner: git
    group: git
    mode: '0700'

# =============================================================================
# INITIAL RECONFIGURE (REQUIRED BEFORE RESTORE)
# =============================================================================

- name: Run initial GitLab reconfigure (first time only)
  ansible.builtin.command: gitlab-ctl reconfigure
  when: not gitlab_managed.stat.exists
  register: initial_reconfigure

- name: Wait for GitLab to be initially ready (first time only)
  ansible.builtin.uri:
    url: "http://localhost:{{ gitlab_port | default('80') }}/-/health"
    method: GET
    status_code: 200
  register: gitlab_health
  until: gitlab_health.status == 200
  retries: 30
  delay: 10
  when: not gitlab_managed.stat.exists and initial_reconfigure.changed

# =============================================================================
# BACKUP RESTORATION (IF AVAILABLE)
# =============================================================================

- name: Restore from latest backup on NAS (first time setup)
  ansible.builtin.shell: |
    set -e
    
    # Determine backup file to use
    if [ -n "{{ latest_backup.stdout }}" ]; then
      backup_file="{{ latest_backup.stdout }}"
    else
      # If forced restore but no latest_backup found, find it again
      backup_file=$(ls -t /mnt/gitlab_data/backups/*_gitlab_backup.tar 2>/dev/null | head -n1 || echo "")
    fi
    
    if [ -z "$backup_file" ]; then
      echo "ERROR: No backup file found for restoration"
      exit 1
    fi
    
    backup_filename=$(basename "$backup_file")
    backup_timestamp=$(echo "$backup_filename" | sed 's/_gitlab_backup\.tar$//')
    
    echo "Found backup: $backup_filename"
    echo "Backup path: $backup_file"
    echo "Extracted timestamp: $backup_timestamp"
    
    # Verify backup file exists
    if [ ! -f "$backup_file" ]; then
      echo "ERROR: Backup file does not exist: $backup_file"
      exit 1
    fi
    
    # Stop GitLab services for restore
    echo "Stopping GitLab services..."
    gitlab-ctl stop puma
    gitlab-ctl stop sidekiq
    
    # Copy backup to local backup directory
    echo "Copying backup file..."
    cp "$backup_file" "/var/opt/gitlab/backups/$backup_filename"
    chown git:git "/var/opt/gitlab/backups/$backup_filename"
    
    # Verify local copy exists
    if [ ! -f "/var/opt/gitlab/backups/$backup_filename" ]; then
      echo "ERROR: Failed to copy backup file locally"
      exit 1
    fi
    
    # List local backups for debugging
    echo "Local backups available:"
    ls -la /var/opt/gitlab/backups/
    
    # Restore the backup using the correct timestamp
    echo "Restoring backup with timestamp: $backup_timestamp"
    gitlab-backup restore BACKUP="$backup_timestamp" force=yes
    
    echo "Backup restoration completed successfully"
  register: backup_restore_result
  when: should_restore_backup | default(false)
  changed_when: true

# =============================================================================
# FRESH INSTALL PASSWORD SETUP
# =============================================================================

- name: Generate random root password (fresh install only)
  ansible.builtin.set_fact:
    gitlab_root_password: >-
      {{ lookup('ansible.builtin.password',
      playbook_dir + '/credentials/hosts/' + inventory_hostname + '/gitlab_root_pass.txt' +
      ' chars=ascii_letters,digits,!@#$%^&*()_+-= length=32') }}
  when: is_fresh_install | default(false)

- name: Set GitLab root password (fresh install only)
  ansible.builtin.shell: |
    gitlab-rails runner "
    user = User.find_by(username: 'root')
    user.password = '{{ gitlab_root_password }}'
    user.password_confirmation = '{{ gitlab_root_password }}'
    user.save!
    puts 'Root password updated successfully'
    "
  when: is_fresh_install | default(false)
  no_log: true

# =============================================================================
# FINAL RECONFIGURATION AND RESTART
# =============================================================================

- name: Final GitLab reconfigure (after restore/password setup)
  ansible.builtin.command: gitlab-ctl reconfigure
  when: not gitlab_managed.stat.exists and (should_restore_backup | default(false) or is_fresh_install | default(false))
  register: final_reconfigure

- name: Restart GitLab services (after restore/password setup)
  ansible.builtin.command: gitlab-ctl restart
  when: not gitlab_managed.stat.exists and (should_restore_backup | default(false) or is_fresh_install | default(false))

- name: Wait for GitLab to be ready (final check)
  ansible.builtin.uri:
    url: "http://localhost:{{ gitlab_port | default('80') }}/-/health"
    method: GET
    status_code: 200
  register: gitlab_final_health
  until: gitlab_final_health.status == 200
  retries: 30
  delay: 10
  when: not gitlab_managed.stat.exists

# =============================================================================
# ONGOING CONFIGURATION (RUNS ON EVERY PLAYBOOK RUN)
# =============================================================================

- name: Ensure GitLab configuration is up to date (ongoing)
  ansible.builtin.template:
    src: gitlab.rb.j2
    dest: /etc/gitlab/gitlab.rb
    mode: '0600'
    owner: root
    group: root
  notify:
    - Reconfigure GitLab
    - Restart GitLab

# =============================================================================
# BACKUP SYSTEM SETUP
# =============================================================================

- name: Create GitLab backup script directory
  ansible.builtin.file:
    path: /opt/gitlab/scripts
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create GitLab backup script
  ansible.builtin.template:
    src: gitlab-backup.sh.j2
    dest: /opt/gitlab/scripts/gitlab-backup.sh
    mode: '0755'
    owner: root
    group: root

- name: Add NAS mount to fstab for automatic mounting
  ansible.posix.mount:
    path: /mnt/gitlab_data
    src: "//{{ nas_ip }}/tank/Server/gitlab"
    fstype: cifs
    opts: "username={{ nas_user }},password={{ nas_password }},uid=0,gid=0,dir_mode=02770,iocharset=utf8,x-systemd.mount-timeout=15min,noauto"
    boot: false  # Explicitly set to false to match noauto option
    state: present

- name: Create backup cron job
  ansible.builtin.cron:
    name: "GitLab daily backup to NAS"
    minute: "0"
    hour: "2"
    job: "/opt/gitlab/scripts/gitlab-backup.sh > /var/log/gitlab-backup.log 2>&1"
    user: root

- name: Create backup log rotation
  ansible.builtin.copy:
    dest: /etc/logrotate.d/gitlab-backup
    content: |
      /var/log/gitlab-backup.log {
          daily
          rotate 7
          compress
          delaycompress
          missingok
          notifempty
          create 0644 root root
      }
    mode: '0644'

# =============================================================================
# SYSTEM CONFIGURATION
# =============================================================================

- name: Allow HTTP traffic
  community.general.ufw:
    rule: allow
    port: 80
    proto: tcp

- name: Enable and start GitLab services
  ansible.builtin.service:
    name: "{{ service_item }}"
    state: started
    enabled: true
  loop:
    - gitlab-runsvdir
  loop_control:
    loop_var: service_item

# =============================================================================
# CLEANUP AND FINALIZATION
# =============================================================================

- name: Mark GitLab as Ansible managed
  ansible.builtin.copy:
    content: "GitLab managed by Ansible on {{ ansible_date_time.iso8601 }}"
    dest: /etc/gitlab/.ansible_managed
    owner: root
    group: root
    mode: '0644'
    force: no

- name: Unmount NAS (cleanup after initial setup)
  ansible.posix.mount:
    path: /mnt/gitlab_data
    state: unmounted
  when: not gitlab_managed.stat.exists