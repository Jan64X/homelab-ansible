- name: Install required packages
  ansible.builtin.apt:
    name:
      - nginx
      - git
      - certbot
      - python3-certbot-dns-cloudflare
      - curl # Needed to fetch CF IPs
      - acl # needed for setting permissions on static site - maybe not? not sure if I deprecated this
    state: present
    update_cache: true
    cache_valid_time: 3600 # Don't update if cache is less than 1 hour old

- name: Create nginx config directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/nginx/conf.d
    - /etc/nginx/ssl
    - /srv/nginx
    - /srv/nginx/logs

- name: Remove default Nginx configuration
  ansible.builtin.file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Reload nginx

# --- DYNAMIC CLOUDFLARE IPS ---

- name: Fetch Cloudflare IPv4 list
  ansible.builtin.uri:
    url: https://www.cloudflare.com/ips-v4
    return_content: true
  register: cf_ipv4

- name: Fetch Cloudflare IPv6 list
  ansible.builtin.uri:
    url: https://www.cloudflare.com/ips-v6
    return_content: true
  register: cf_ipv6

# --- CERTBOT SETUP ---

- name: Create Cloudflare credentials directory
  ansible.builtin.file:
    path: /etc/letsencrypt
    state: directory
    mode: '0755'

- name: Create Cloudflare API credentials file
  ansible.builtin.copy:
    dest: /etc/letsencrypt/cloudflare.ini
    mode: '0600'
    content: |
      dns_cloudflare_api_token = {{ cloudflare_api_token }}

- name: Generate initial Certificate (Wildcard)
  ansible.builtin.command:
    cmd: >
      certbot certonly --dns-cloudflare
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini
      --dns-cloudflare-propagation-seconds 60
      --non-interactive --agree-tos --email {{ certbot_email }}
      --cert-name {{ base_domain }}
      -d {{ base_domain }} -d *.{{ base_domain }}
      --keep-until-expiring
  # Only run if the cert file doesn't exist yet
  args:
    creates: "/etc/letsencrypt/live/{{ base_domain }}/fullchain.pem"

- name: Ensure renewal hooks directory exists
  ansible.builtin.file:
    path: /etc/letsencrypt/renewal-hooks/deploy
    state: directory
    mode: '0755'

- name: Add a deploy hook for Nginx reload
  ansible.builtin.copy:
    dest: /etc/letsencrypt/renewal-hooks/deploy/nginx_reload
    mode: '0755'
    content: |
      #!/bin/sh
      systemctl reload nginx

# --- NGINX CONFIGURATION ---

- name: Generate dhparams (this takes a while)
  community.crypto.openssl_dhparam:
    path: /etc/nginx/dhparam.pem
    size: 2048

- name: Configure Main Nginx
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
    validate: 'nginx -t -c %s'
    mode: '0644'
  notify: Reload nginx

- name: Configure virtual hosts
  ansible.builtin.template:
    src: "{{ item }}.conf.j2"
    dest: "/etc/nginx/conf.d/{{ item }}.conf"
    mode: '0644'
  loop: "{{ nginx_vhosts }}"
  notify: Reload nginx

# --- DEPLOYMENT ---

- name: Ensure target directory exists
  ansible.builtin.file:
    path: "{{ static_website.local_path }}"
    state: directory
    mode: '0755'
    owner: root
    group: root
  when: static_website.enabled | default(false)

- name: Deploy Static Site
  ansible.builtin.git:
    repo: "{{ static_website.repo_url }}"
    dest: "{{ static_website.local_path }}"
    version: "{{ static_website.repo_branch }}"
    force: true
    depth: 1
  when: static_website.enabled | default(false)
  register: nginx_gateway_git_deploy

- name: Enforce Secure/Read-Only permissions
  ansible.builtin.file:
    path: "{{ static_website.local_path }}"
    state: directory
    recurse: true
    owner: root
    group: root
    # capital 'X' sets execute only for directories
    # result: Files = 644 (rw-r--r--), Dirs = 755 (rwxr-xr-x)
    mode: u=rwX,g=rX,o=rX
  when: static_website.enabled | default(false)

# --- SERVICES ---

- name: Ensure Certbot renewal timer is active
  ansible.builtin.service:
    name: certbot.timer
    state: started
    enabled: true

- name: Ensure nginx is running
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: true

- name: Allow HTTP and HTTPS
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "80"
    - "443"
